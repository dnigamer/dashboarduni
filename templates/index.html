<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <title>Dashboard Gastos Universidade</title>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', path='/styles.css') }}">
</head>

<body>
    <div class="container">
        <div class="row">
            <div class="col-12 mt-5">
                <h1>Dashboard Gastos Universidade</h1>
                <p>Dashboard para guardar todos os gastos com quaisquer produtos ou coisas relacionadas com a
                    universidade.</p>
            </div>
            <div class="col-12 mt-4">
                <nav>
                    <ul class="nav nav-tabs" id="nav-tab" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link" id="nav-saldo-tab" data-bs-toggle="tab" href="#nav-saldo" role="tab"
                                aria-controls="nav-saldo" aria-selected="true">Consultar saldo</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="nav-registar-tab" data-bs-toggle="tab" href="#nav-registar"
                                role="tab" aria-controls="nav-registar" aria-selected="false">Registar
                                débito/crédito</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="nav-consulta-tab" data-bs-toggle="tab" href="#nav-consulta"
                                role="tab" aria-controls="nav-consulta" aria-selected="false">Consultar operações</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="nav-definicoes-tab" data-bs-toggle="tab" href="#nav-definicoes"
                                role="tab" aria-controls="nav-definicoes" aria-selected="false">Definições</a>
                        </li>
                    </ul>
                </nav>
                <div class="tab-content" id="nav-tabContent">
                    <div class="tab-pane fade" id="nav-saldo" role="tabpanel" aria-labelledby="nav-saldo-tab">
                        <div class="container col-13 mt-4">
                            <h5>Saldo ainda disponível:</h5>
                            <h3 id="saldoplaceholder"></h3>

                            <button type="button" class="btn btn-primary" id="saldoHiderBtn">Mostrar/Esconder
                                saldo</button>
                            <script>
                                $(document).ready(function () {
                                    let saldo;
                                    var balState = localStorage.getItem("balanceActive") === "true";
                                    var loaded = false;
                                    var saldohiderbtn = $("#saldoHiderBtn");

                                    $("#saldoplaceholder").text("A carregar...");

                                    $.ajax({
                                        url: '/api/saldo',
                                        method: 'GET',
                                        success: function (data) {
                                            saldo = data.saldo;
                                            if (balState) {
                                                $("#saldoplaceholder").text(saldo + " €");
                                                saldohiderbtn.html("Mostrar saldo").addClass("btn-success");
                                            } else {
                                                $("#saldoplaceholder").text("-.-- €");
                                                saldohiderbtn.html("Esconder saldo").addClass("btn-danger");
                                            }
                                            loaded = true;
                                        },
                                        error: function (request, status, error) {
                                            console.log('Error retrieving saldo from API');
                                            console.log(request.responseText);
                                            $("#saldoplaceholder").text("N/D €");
                                            saldohiderbtn.html("Erro ao obter saldo").addClass("btn-secondary");
                                        }
                                    });

                                    saldohiderbtn.click(function () {
                                        if (!loaded) return;
                                        balState = !balState;
                                        if (balState) {
                                            saldohiderbtn.html("Mostrar saldo").removeClass("btn-danger").addClass("btn-success");
                                            $("#saldoplaceholder").text(saldo + " €");
                                        } else {
                                            saldohiderbtn.html("Esconder saldo").removeClass("btn-success").addClass("btn-danger");
                                            $("#saldoplaceholder").text("-.-- €");
                                        }
                                        localStorage.setItem("balanceActive", balState);
                                    });
                                });
                            </script>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="nav-registar" role="tabpanel" aria-labelledby="nav-registar-tab">
                        <div class="container col-13 mt-4">
                            <h5>Registar débito/crédito</h5>
                            <form>
                                <div class="mb-3">
                                    <label for="valor" class="form-label">Valor</label>
                                    <input type="text" class="form-control" id="valor" placeholder="0.00 €" />

                                    <script>
                                        const input = document.getElementById('valor');
                                        var verifiedInput = false;
                                        input.addEventListener('blur', (event) => {
                                            const value = event.target.value;
                                            if (value) {
                                                const numberValue = parseFloat(value.replace(',', '.'));
                                                if (!isNaN(numberValue)) {
                                                    const formattedValue = `${numberValue.toFixed(2)} €`.replace(/^0+/, '');
                                                    event.target.value = formattedValue;
                                                    if (document.getElementById('valor').classList.contains('invalid-input')) {
                                                        document.getElementById('valor').classList.remove('invalid-input');
                                                    }
                                                    verifiedInput = true;
                                                } else {
                                                    verifiedInput = false;
                                                }
                                            }
                                        });
                                    </script>
                                </div>

                                <div class="mb-3">
                                    <label for="descricao" class="form-label">Descrição</label>
                                    <input type="text" class="form-control" id="descricao">
                                </div>

                                <div class="mb-3">
                                    <label for="tipo" class="form-label">Tipo</label>
                                    <select class="form-select" id="tipo">
                                        <option selected disabled></option>
                                        <option value="1">Débito</option>
                                        <option value="2">Crédito</option>
                                    </select>
                                </div><br />

                                <button type="button" class="btn btn-primary" id="submeterRegisto">Submeter
                                    entrada</button>

                                <!-- Summary modal -->
                                <div class="modal fade" id="summary-modal" tabindex="-1"
                                    aria-labelledby="summary-modal-label" aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="summary-modal-label">Resumo do registo</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                    aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body" id="summary-modal-body"></div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-danger"
                                                    data-bs-dismiss="modal">Não</button>
                                                <button type="button" class="btn btn-success" id="summaryApproval"
                                                    data-bs-dismiss="modal">Sim</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Information form modal (for general use in errors or success) -->
                                <div id="informationForm" class="modal fade" role="dialog">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="inf-modal-label">Informação</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                    aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body" id="inf-modal-body"></div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-success"
                                                    data-bs-dismiss="modal">OK</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <script type="text/javascript">
                                    function showSummary() {
                                        const valor = document.getElementById('valor').value;
                                        const descricao = document.getElementById('descricao').value;
                                        const tipo = document.getElementById('tipo').value;

                                        if (valor == '' || descricao == '' || tipo == '') {
                                            const incompleteBody = `
                                                <h4>Erro - Campos não preenchidos</h4>
                                                <p>Não introduziu alguns dados necessários para submeter o formulário.</p>
                                                <p>Verifique os valores introduzidos e tente novamente.</p>
                                            `
                                            const incompleteModalBody = document.getElementById('inf-modal-body');
                                            incompleteModalBody.innerHTML = incompleteBody;
                                            $('#informationForm').modal('show');

                                            return;
                                        }

                                        // check if valor is numeric and if not show a modal
                                        if (!verifiedInput) {
                                            const invalidBody = `
                                                <h4>Erro - Campos com valores inválidos</h4>
                                                <p>O campo de <b>valor</b> contém caracteres não numéricos.</p>
                                                <p>Verifique os valores introduzidos e tente novamente.</p>
                                            `
                                            const invalidModalBody = document.getElementById('inf-modal-body');
                                            invalidModalBody.innerHTML = invalidBody;
                                            $('#informationForm').modal('show');

                                            document.getElementById('valor').value = '';
                                            document.getElementById('valor').focus();
                                            document.getElementById('valor').classList.add('invalid-input');

                                            return;
                                        }

                                        try {
                                            parseFloat(tipo);
                                        } catch (error) {
                                            const invalidBody = `
                                                <h4>Erro - Campos com valores inválidos</h4>
                                                <p>O campo de <b>tipo</b> tem um valor inválido ou não suportado.</p>
                                                <p>Verifique os valores introduzidos e tente novamente.</p>
                                            `
                                            const invalidModalBody = document.getElementById('inf-modal-body');
                                            invalidModalBody.innerHTML = invalidBody;
                                            $('#informationForm').modal('show');

                                            document.getElementById('tipo').value = '';
                                            document.getElementById('tipo').focus();
                                            document.getElementById('tipo').classList.add('invalid-input');

                                            return;
                                        }

                                        const summary = `
                                            <p><b>Valor:</b> ${valor}</p>
                                            <p><b>Descrição:</b> ${descricao}</p>
                                            <p><b>Tipo:</b> ${tipo === '1' ? 'Débito' : 'Crédito'}</p>
                                            <p><b>Data:</b> ${new Date().toLocaleDateString()}</p>
                                            <p><b>Hora:</b> ${new Date().toLocaleTimeString()}</p>
                                            <br\>
                                            <p>Confirma o registo?</p>
                                        `;

                                        const summaryModalBody = document.getElementById('summary-modal-body');
                                        summaryModalBody.innerHTML = summary;
                                        $('#summary-modal').modal('show');
                                    }

                                    function submitForm() {
                                        let valorStr = document.getElementById('valor').value;
                                        const valor = parseFloat(valorStr.replace(' €', '').replace(',', '.'));
                                        const descricao = document.getElementById('descricao').value;
                                        const tipo = parseFloat(document.getElementById('tipo').value);
                                        const data = new Date().toLocaleDateString();
                                        const hora = new Date().toLocaleTimeString();

                                        $.ajax({
                                            url: '/api/registar',
                                            method: 'POST',
                                            contentType: 'application/json',
                                            dataType: 'json',
                                            data: JSON.stringify({
                                                valor: valor,
                                                descricao: descricao,
                                                tipo: tipo,
                                                data: data,
                                                hora: hora
                                            }),
                                            success: function (request, text) {
                                                localStorage.setItem('postingRecord', "success");
                                                const jsonData = JSON.stringify(request);
                                                localStorage.setItem('postingRecordData', jsonData);
                                                location.reload();
                                            },
                                            error: function (request, status, error) {
                                                localStorage.setItem('postingRecord', "fail");
                                                localStorage.setItem('postingRecordData', request.responseText);
                                                location.reload();
                                            }
                                        });
                                    }

                                    $("#summaryApproval").click(function () {
                                        submitForm();
                                    });

                                    $("#submeterRegisto").click(function () {
                                        showSummary();
                                    });
                                </script>
                            </form>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="nav-consulta" role="tabpanel" aria-labelledby="nav-consulta-tab">
                        <div class="container col-13 mt-4">
                            <h5>Consultar operações</h5>
                            <form>
                                <div class="mb-3">
                                    <label for="datainicio" class="form-label">Data de início</label>
                                    <input type="date" class="form-control" id="datainicio"
                                        placeholder="Data de início">
                                </div>
                                <div class="mb-3">
                                    <label for="datafim" class="form-label">Data de fim</label>
                                    <input type="date" class="form-control" id="datafim" placeholder="Data de fim">
                                </div>
                                <div class="mb-3">
                                    <label for="tipo" class="form-label">Tipo</label>
                                    <select class="form-select" id="tipo">
                                        <option selected disabled></option>
                                        <option value="1">Débito</option>
                                        <option value="2">Crédito</option>
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-primary">Consultar</button>
                            </form>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="nav-definicoes" role="tabpanel" aria-labelledby="nav-definicoes-tab">
                        <div class="container col-13 mt-4">
                            <h5>Definições</h5>
                            <div class="form-check form-switch dark-mode-switch">
                                <input class="form-check-input" type="checkbox" id="dark-mode-switch">
                                <label class="form-check-label" for="dark-mode-switch">Modo escuro</label>
                            </div>
                            <script>
                                const darkModeSwitch = $('#dark-mode-switch');
                                darkModeSwitch.click(function () {
                                    const isLight = document.body.dataset.bsTheme === 'light';
                                    const isDark = document.body.dataset.bsTheme === 'dark';
                                    const isSwitchedOn = darkModeSwitch.prop('checked');
                                    const isSwitchedOff = !isSwitchedOn;
                                    localStorage.setItem('darkMode', isSwitchedOn);
                                    document.body.dataset.bsTheme = isSwitchedOn ? 'dark' : 'light';
                                });
                            </script>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        $(document).ready(function () { var lastTab = localStorage.getItem('lastTab'); lastTab ? $('#' + lastTab).tab('show') : $('#nav-tab a:first').tab('show'); $('a[data-bs-toggle="tab"]').on('shown.bs.tab', function (e) { localStorage.setItem('lastTab', $(e.target).attr('id')) }) });
        $(document).ready(function () { var darkMode = localStorage.getItem('darkMode'); if (darkMode === 'true') { $('#dark-mode-switch').prop('checked', true); document.body.dataset.bsTheme = 'dark'; } else { document.body.dataset.bsTheme = 'light'; } });
        $(document).ready(function () {
            const postingRecord = localStorage.getItem("postingRecord");
            if (postingRecord === "success") {
                console.log("Last success on posting data");
                const jsonData = JSON.parse(localStorage.getItem("postingRecordData"));
                const successBody = `
                    <h4>Registo efetuado com sucesso</h4>
                    <p>O registo foi efetuado com sucesso.</p><br\>
                    <p><b>Dados adicionais: </b></p>
                    <ul>
                        <li><b>Estado do registo:</b> ${jsonData.httpState}</li>
                        <li><b>ID do registo:</b> ${jsonData.idRecord}</li>
                    </ul>
                `;
                const successModalBody = document.getElementById("inf-modal-body");
                successModalBody.innerHTML = successBody;
                $("#informationForm").modal("show");
                localStorage.removeItem("postingRecord");
                localStorage.removeItem("postingRecordData");
            } else if (postingRecord === "fail") {
                console.log("Last fail on posting data");
                const errorData = JSON.parse(localStorage.getItem("postingRecordData"));
                const errorBody = `
                    <h4>Erro ao efetuar registo</h4>
                    <p>O registo não pode ser efetuado devido a um erro no servidor. Por favor, tente novamente mais tarde.</p>
                    <p>Se o erro persistir, contacte o administrador.</p><br\>
                    <p><b>Detalhes do erro:</b></p>
                    <ul>
                        <li><b>Código HTTP: </b>${errorData.detail.httpCode}</li>
                        <li><b>Estado HTTP: </b>${errorData.detail.httpState}</li>
                        <li><b>Erro: </b>${errorData.detail.errorData}</li>
                    </ul>
                `;
                const errorModalBody = document.getElementById("inf-modal-body");
                errorModalBody.innerHTML = errorBody;
                $("#informationForm").modal("show");
                localStorage.removeItem("postingRecord");
                localStorage.removeItem("postingRecordData");
            }
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>
</body>

</html>